<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Receitas Públicas - Pesquisa</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://accounts.google.com/gsi/client" async defer onload="onGoogleLoad()"></script>
</head>
<body>
    <div id="g_id_onload"
        data-client_id="771237843090-3keu5f222jtid17khsqbgqqscn2ttunv.apps.googleusercontent.com"
        data-callback="handleCredentialResponse"
        data-auto_prompt="true">
    </div>

    <header>
        <div class="perfil-topo">
            <div class="perfil-info">
                <img id="imgAvatar" src="" class="foto-user" alt="Avatar" hidden="true">
                <h3 id="txtNome" hidden="true">Carregando...</h3>
            </div>
        </div>
        
        <h1>Explorador de Receitas</h1>

        <div class="login">
            <div id="botaoGoogleDiv"></div>
        </div>
    </header>

    <hr>

    <div id="lista-resultados">
        <h2>Carregando título...</h2>

        <div id="menu-semanal"></div>
    </div>
    <script src="app.js" defer></script>

    <script>
    function onGoogleLoad() {
        if (!window.google || !google.accounts || !google.accounts.id) return;
        google.accounts.id.initialize({
            client_id: "771237843090-3keu5f222jtid17khsqbgqqscn2ttunv.apps.googleusercontent.com",
            callback: handleCredentialResponse,
            cancel_on_tap_outside: false
        });

        google.accounts.id.renderButton(
            document.getElementById("botaoGoogleDiv"),
            { 
                theme: "outline",
                size: "large",
                shape: "pill",
                text: "signin_with",
                width: 250
            }
        );
    }

    function handleCredentialResponse(response) {
    // 1. Descodificar o token
    const dados = decodeJwtResponse(response.credential);
    
    console.log("Utilizador logado: " + dados.email);

    // 2. Guardar na Sessão (para a página privada saber quem é)
    sessionStorage.setItem("usuarioEmail", dados.email);
    sessionStorage.setItem("usuarioNome", dados.name);
    sessionStorage.setItem("usuarioFoto", dados.picture);

    // 3. Redirecionar para a página privada (Menu Semanal)
    window.location.href = "admin.html"; 
}

function decodeJwtResponse(token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
}
    </script>
</body>
</html>